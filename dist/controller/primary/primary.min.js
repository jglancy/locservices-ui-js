define(["jquery","locservices/core/api","locservices/core/preferred_location","locservices/core/bbc_cookies","locservices/core/cookies","locservices/ui/component/search","locservices/ui/component/message","locservices/ui/component/geolocation","locservices/ui/component/auto_complete","locservices/ui/component/search_results","locservices/ui/component/user_locations","locservices/ui/component/close_button","locservices/ui/component/dialog"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";function n(m){q(m);var n=this,r=m.alwaysOpen||!1,s={onLocation:function(a){n.selectLocation(a)},onActive:function(){a.emit(n.namespace+":controller:active"),n.container.addClass("ls-ui-ctrl-active")},onGeolocation:function(){n.container.addClass("ls-ui-ctrl-geolocation")},onSearchResults:function(){n.container.find(".ls-ui-comp-user_locations").addClass("ls-ui-hidden")},onClose:function(){n.message.clear(),n.results.clear(),n.autoComplete.clear(),a.emit(n.namespace+":controller:inactive"),n.container.removeClass("ls-ui-ctrl-active"),n.container.find(".ls-ui-comp-user_locations").removeClass("ls-ui-hidden")}};n.translations=m.translations,n.api=new b(m.api),n.container=m.container,n.preferredLocation=new c(n.api),n.bbcCookies=new d,n.cookies=new e,n.cookiesColdStartKey="locserv_uics",n.container.addClass("ls-ui-ctrl-primary").append(o.append(p)),n.namespace=m.namespace||"locservices:ui",a.on(n.namespace+":error",s.onActive),a.on(n.namespace+":component:search:focus",s.onActive),a.on(n.namespace+":component:auto_complete:render",s.onSearchResults),a.on(n.namespace+":component:search:results",s.onSearchResults),a.on(n.namespace+":component:geolocation:location",s.onLocation),a.on(n.namespace+":component:auto_complete:location",s.onLocation),a.on(n.namespace+":component:user_locations:location",s.onLocation),a.on(n.namespace+":component:search_results:location",s.onLocation),a.on(n.namespace+":component:geolocation:available",s.onGeolocation),a.on(n.namespace+":component:close_button:clicked",s.onClose),n.search=new f({api:this.api,translations:n.translations,eventNamespace:n.namespace,container:p}),n.autoComplete=new i({api:this.api,translations:n.translations,eventNamespace:n.namespace,element:n.search.input,container:o}),n.message=new g({translations:n.translations,eventNamespace:n.namespace,container:o}),n.results=new j({api:this.api,translations:n.translations,eventNamespace:n.namespace,container:o}),n.geolocation=new h({api:this.api,translations:n.translations,eventNamespace:n.namespace,container:o}),n.userLocations=new k({api:this.api,translations:n.translations,eventNamespace:n.namespace,container:o}),r||(n.closeButton=new l({translations:n.translations,eventNamespace:n.namespace,container:o})),r&&(n.container.addClass("ls-ui-ctrl-open"),a.emit(n.namespace+":component:search:focus"))}var o=a("<div />").addClass("ls-ui-o"),p=a("<div />").addClass("ls-ui-ctrl-primary-search"),q=function(a){for(var b=["api","translations","container"],c=b.length,d=0;c>d;d++){var e=b[d];if(!a[e])throw new Error("Primary Controller requires an "+e+" option.")}};return n.prototype.selectLocation=function(b){var c=this,d=function(){a.emit(c.namespace+":controller:location",[b])},e=function(){c.preferredLocation.set(b.id,{success:function(){d()},error:function(){d()}})},f=function(){var a=new Date;a.setFullYear(a.getFullYear()+1),c.cookies.set(c.cookiesColdStartKey,"1",a.toUTCString(),"/",c.preferredLocation.getCookieDomain()),d()};this.preferredLocation.isValidLocation(b)&&this.shouldColdStartDialogBeDisplayed()?new m({container:o,message:c.translations.get("primary.cold_start",{name:b.name}),confirmLabel:c.translations.get("user_locations.dialog.confirm"),cancelLabel:c.translations.get("user_locations.dialog.cancel"),confirm:function(){e()},cancel:function(){f()}}):d()},n.prototype.shouldColdStartDialogBeDisplayed=function(){return!1===this.preferredLocation.isSet()&&!1===this.bbcCookies.isPersonalisationDisabled()&&this.cookies.isSupported()&&"1"!==this.cookies.get(this.cookiesColdStartKey)},n});