define(["jquery","locservices/core/api","locservices/core/preferred_location","locservices/core/bbc_cookies","locservices/core/cookies","locservices/ui/component/search","locservices/ui/component/message","locservices/ui/component/geolocation","locservices/ui/component/auto_complete","locservices/ui/component/search_results","locservices/ui/component/user_locations","locservices/ui/component/close_button","locservices/ui/component/dialog","locservices/ui/utils/stats"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";function o(m){r(m),m.hasOwnProperty("echoClient")&&"object"==typeof m.echoClient&&(this._stats=new n(m.echoClient));var o=this,s=m.alwaysOpen||!1,t={onLocation:function(a){o.selectLocation(a)},onActive:function(){a.emit(o.namespace+":controller:active"),o.container.addClass("ls-ui-ctrl-active")},onGeolocation:function(){o.container.addClass("ls-ui-ctrl-geolocation")},onSearchResults:function(){o.container.find(".ls-ui-comp-user_locations").addClass("ls-ui-hidden")},onClose:function(){o.message.clear(),o.results.clear(),o.autoComplete.clear(),a.emit(o.namespace+":controller:inactive"),o.container.removeClass("ls-ui-ctrl-active"),o.container.find(".ls-ui-comp-user_locations").removeClass("ls-ui-hidden")}};o.translations=m.translations,o.api=new b(m.api),o.container=m.container,o.preferredLocation=new c(o.api),o.bbcCookies=new d,o.cookies=new e,o.cookiesColdStartKey="locserv_uics",o.container.addClass("ls-ui-ctrl-primary").append(p.append(q)),o.namespace=m.namespace||"locservices:ui",a.on(o.namespace+":error",t.onActive),a.on(o.namespace+":component:search:focus",t.onActive),a.on(o.namespace+":component:auto_complete:render",t.onSearchResults),a.on(o.namespace+":component:search:results",t.onSearchResults),a.on(o.namespace+":component:geolocation:location",t.onLocation),a.on(o.namespace+":component:auto_complete:location",t.onLocation),a.on(o.namespace+":component:user_locations:location",t.onLocation),a.on(o.namespace+":component:search_results:location",t.onLocation),a.on(o.namespace+":component:geolocation:available",t.onGeolocation),a.on(o.namespace+":component:close_button:clicked",t.onClose),o.search=new f({api:this.api,translations:o.translations,eventNamespace:o.namespace,container:q}),o.autoComplete=new i({api:this.api,translations:o.translations,eventNamespace:o.namespace,element:o.search.input,container:p}),o.message=new g({translations:o.translations,eventNamespace:o.namespace,container:p}),o.results=new j({api:this.api,translations:o.translations,eventNamespace:o.namespace,container:p}),o.geolocation=new h({api:this.api,translations:o.translations,eventNamespace:o.namespace,container:p}),o.userLocations=new k({api:this.api,translations:o.translations,eventNamespace:o.namespace,container:p}),s||(o.closeButton=new l({translations:o.translations,eventNamespace:o.namespace,container:p})),s&&(o.container.addClass("ls-ui-ctrl-open"),a.emit(o.namespace+":component:search:focus"))}var p=a("<div />").addClass("ls-ui-o"),q=a("<div />").addClass("ls-ui-ctrl-primary-search"),r=function(a){for(var b=["api","translations","container"],c=b.length,d=0;c>d;d++){var e=b[d];if(!a[e])throw new Error("Primary Controller requires an "+e+" option.")}};return o.prototype.selectLocation=function(b){var c=this,d=function(){a.emit(c.namespace+":controller:location",[b])},e=function(){c.preferredLocation.set(b.id,{success:function(){d()},error:function(){d()}})},f=function(){var a=new Date;a.setFullYear(a.getFullYear()+1),c.cookies.set(c.cookiesColdStartKey,"1",a.toUTCString(),"/",c.preferredLocation.getCookieDomain()),d()};this.preferredLocation.isValidLocation(b)&&this.shouldColdStartDialogBeDisplayed()?new m({container:p,message:c.translations.get("primary.cold_start",{name:b.name}),confirmLabel:c.translations.get("user_locations.dialog.confirm"),cancelLabel:c.translations.get("user_locations.dialog.cancel"),confirm:function(){e()},cancel:function(){f()}}):d()},o.prototype.shouldColdStartDialogBeDisplayed=function(){return!1===this.preferredLocation.isSet()&&!1===this.bbcCookies.isPersonalisationDisabled()&&this.cookies.isSupported()&&"1"!==this.cookies.get(this.cookiesColdStartKey)},o});