define(["jquery","locservices/ui/component/component"],function(a,b){function c(b){var c=this;if(b=b||{},b.componentId="autocomplete",this._waitingForResults=!1,this._searchSubmitted=!1,this._timeoutId=void 0,this._highlightedSearchResultIndex=null,"object"!=typeof b.api)throw new Error("AutoComplete requires an api option");if(this._api=b.api,!b.element instanceof a)throw new Error("AutoComplete requires an element option");this.input=b.element,this.input.attr("autocomplete","off"),this.searchResultsData=null,this.setComponentOptions(b),this.on("results",function(a){c.renderSearchResults(a)}),a.on(this.eventNamespaceBase+":component:search:start",function(){c._searchSubmitted=!0}),this.searchResults=a("<ul />").addClass("ls-ui-autocomplete-results"),this.container.append(this.searchResults),this.searchResults.on("mouseover","li",function(){c.highlightSearchResultByIndex(a(this).index(),!1)}).on("mouseout","li",function(){a(this).removeClass("ls-ui-active")}).on("mousedown","li",function(){var b=c.searchResultsData[a(this).index()];c.emit("location",[b]),c.clear()}),a(document).on("keydown",function(a){switch(a.keyCode){case d.escape:c.escapeKeyHandler();break;case d.enter:c.enterKeyHandler(a);break;case d.upArrow:a.preventDefault(),c.highlightPrevSearchResult();break;case d.downArrow:c.highlightNextSearchResult()}}),this.input.on("keyup",function(a){var b=a.keyCode;b!==d.escape&&b!==d.enter&&b!==d.upArrow&&b!==d.downArrow&&c.autoComplete()})}var d={enter:13,escape:27,upArrow:38,downArrow:40},e=2,f=500;return c.prototype=new b,c.prototype.constructor=c,c.prototype.prepareSearchTerm=function(a){return String(a).replace(/^\s\s*/,"").replace(/\s\s*$/,"")},c.prototype.isValidSearchTerm=function(a){var b,c;return"string"!=typeof a?!1:(b=this.prepareSearchTerm(a),c=b.length>=e)},c.prototype.highlightTerm=function(a,b){var c=new RegExp(b,"i"),d=a.search(c);return d>=0?a.substr(0,d)+"<strong>"+a.substr(d,d+b.length)+"</strong>"+a.substr(d+b.length):a},c.prototype.autoComplete=function(){var a=this.prepareSearchTerm(this.input.val()),b=this;this._waitingForResults||!this.isValidSearchTerm(a)||a.length<e||(clearTimeout(this._timeoutId),this._timeoutId=setTimeout(function(){!0!==b._searchSubmitted&&(b._waitingForResults=!0,b.currentSearchTerm=a,b._api.autoComplete(a,{success:function(a){b._waitingForResults=!1,!0!==b._searchSubmitted&&b.emit("results",[a.results,a.metadata])},error:function(){!0!==b._searchSubmitted&&b.emit("error",[{code:"autocomplete.error.search",message:"There was a problem searching for the search term"}])}}))},f),this._searchSubmitted=!1)},c.prototype.clear=function(){this.searchResultsData=null,this._highlightedSearchResultIndex=null,this.searchResults.empty(),this.emit("clear")},c.prototype.renderSearchResults=function(a){var b,c,d="",e="",f={};if(b=this,b.searchResultsData=a,0===a.length)return void this.clear();for(b.emit("render"),c=0;c<a.length;c++)f=a[c],e=f.name,f.container&&(e+=", "+f.container),e=b.highlightTerm(e,this.currentSearchTerm),d+='<li><a href="#" data-index="'+c+'">'+e+"</a></li>";this.searchResults.empty(),this.searchResults.append(d),this.searchResults.find("li a").on("click",function(a){a.preventDefault(),a.stopPropagation()})},c.prototype.escapeKeyHandler=function(){null!==this._highlightedSearchResultIndex&&this.input.val(this.currentSearchTerm),this.clear()},c.prototype.enterKeyHandler=function(a){if(null!==this._highlightedSearchResultIndex){a.preventDefault();var b=this.searchResultsData[this._highlightedSearchResultIndex];this.emit("location",[b])}this.clear()},c.prototype.highlightNextSearchResult=function(){var a=this._highlightedSearchResultIndex;if(null===a)a=0;else if(a++,this.searchResultsData.length<=a)return void this.removeSearchResultHighlight(!0);this.highlightSearchResultByIndex(a,!0)},c.prototype.highlightPrevSearchResult=function(){var a;if(a=this._highlightedSearchResultIndex,null===a)a=this.searchResultsData.length-1;else if(a--,0>a)return void this.removeSearchResultHighlight(!0);this.highlightSearchResultByIndex(a,!0)},c.prototype.highlightSearchResultByIndex=function(b,c){var d=this.searchResultsData[b],e=d.name;d.container&&(e+=", "+d.container),this.removeSearchResultHighlight(),this._highlightedSearchResultIndex=b,a(this.searchResults.find("li")[b]).addClass("ls-ui-active"),c&&this.input.val(e)},c.prototype.removeSearchResultHighlight=function(a){this._highlightedSearchResultIndex=null,this.searchResults.find("li.ls-ui-active").removeClass("ls-ui-active"),a&&this.input.val(this.currentSearchTerm)},c});