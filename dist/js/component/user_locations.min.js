define(["jquery","locservices/ui/component/component","locservices/core/recent_locations","locservices/core/preferred_location"],function(a,b,c,d){"use strict";function e(b){var e=this;b=b||{},b.componentId="user_locations",this.setComponentOptions(b),this.preferredLocation=new d,this.recentLocations=new c,f.element.on("click",function(b){var c,d;b.preventDefault(),b.stopPropagation(),c=a(b.target),c.hasClass("ls-ui-comp-user_locations-recent")?(d=c.attr("href").split("=")[1],e.setPreferredLocationById(d)):c.hasClass("ls-ui-comp-user_locations-remove")&&(d=c.attr("href").split("=")[1],e.removeLocationById(d))}),this.container.append(f.element),this.render(),a.on(this.eventNamespaceBase+":component:search_results:location",function(a){e.addRecentLocation(a)}),a.on(this.eventNamespaceBase+":component:geolocation:location",function(a){e.addRecentLocation(a)}),a.on(this.eventNamespaceBase+":component:auto_complete:location",function(a){e.addRecentLocation(a)})}var f={element:a("<div />").addClass("ls-ui-comp-user_locations"),preferredLocationList:a("<ul/>").addClass("ls-ui-comp-user_locations-preferred"),preferredLocationHeading:function(b){return a("<p />").text(b.get("user_locations.heading.preferred"))},recentLocationsList:a("<ul/>").addClass("ls-ui-comp-user_locations-recent"),recentLocationsHeading:function(b,c){return a("<p />").text(b.get("user_locations.heading.recent")+" ("+c+")")},location:function(b,c){var d=c.id,e=a("<a/>").addClass("ls-ui-comp-user_locations-name").attr("href","?locationId="+d).html(a("<strong/>").text(c.name));c.container&&e.append(", "+c.container);var f=a("<a/>").addClass("ls-ui-comp-user_locations-action").attr("href","?locationId="+d).text(b.get("user_locations.action.recent")),g=a("<a/>").addClass("ls-ui-comp-user_locations-remove").attr("href","?locationId="+d).text(b.get("user_locations.action.remove")),h=a("<li />");return c.isPreferred&&h.addClass("ls-ui-comp-user_locations-location-preferred"),c.isPreferable&&(h.addClass("ls-ui-comp-user_locations-location-preferable"),h.append(f)),h.append(e).append(g),h},message:function(b,c){var d=b.get("user_locations.message.preferred");return c&&(d+=" "+b.get("user_locations.message.change_preferred")),a("<p/>").text(d)}};return e.prototype=new b,e.prototype.constructor=e,e.prototype.setPreferredLocationById=function(a){var b,c,d,e;for(c=this.getRecentLocations(),e=c.length,d=0;e>d;d++)a===c[d].id&&(b=c[d]);b&&(this.preferredLocation.set(b),this.render())},e.prototype.addRecentLocation=function(a){try{this.recentLocations.add(a)}catch(b){return}this.render()},e.prototype.removeLocationById=function(a){this.recentLocations.remove(a),this.render()},e.prototype.render=function(){var a,b,c,d,e;if(f.element.empty(),f.preferredLocationList.empty(),f.recentLocationsList.empty(),f.element.append(f.preferredLocationHeading(this.translations)),this.preferredLocation.isSet()?(a=this.preferredLocation.get(),a.isPreferred=!0,a.isPreferable=!0,f.preferredLocationList.append(f.location(this.translations,a))):f.preferredLocationList.addClass("ls-ui-comp-user_locations-preferred-no-location"),f.element.append(f.preferredLocationList),b=this.getRecentLocations(),d=b.length,c=d>0,f.element.append(f.recentLocationsHeading(this.translations,d)),c){for(e=0;d>e;e++)f.recentLocationsList.append(f.location(this.translations,b[e]));f.element.append(f.recentLocationsList)}f.element.append(f.message(this.translations,c))},e.prototype.getRecentLocations=function(){var a,b,c,d,e,f=[],g=5;if(this.preferredLocation.isSet()&&(g--,a=this.preferredLocation.get()),this.recentLocations.isSupported()&&(b=this.recentLocations.all(),c=b.length,c>0))for(e=0;c>e&&(d=b[e],g>0&&(!a||a&&a.id!==d.id)&&(g--,d.isPreferable=this.preferredLocation.isValidLocation(d),f.push(d)),0!==g);e++);return f},e});