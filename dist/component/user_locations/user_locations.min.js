define(["jquery","locservices/ui/component/component","locservices/core/bbc_cookies","locservices/core/recent_locations","locservices/core/preferred_location"],function(a,b,c,d,e){"use strict";function f(b){var f,h,i=this;if(b=b||{},b.componentId="user_locations",void 0===b.api)throw new Error("User locations requires api parameter");if(f=b.api,this.setComponentOptions(b),h=new c,!h.isPersonalisationDisabled()){this._locations=[],this.preferredLocation=new e(f),this.recentLocations=new d,this.element=g.element(),this.container.append(this.element),this.render(),this.element.on("click",function(b){var c,d,e;b.preventDefault(),b.stopPropagation(),c=a(b.target),d=String(c.data("id")),e=c.data("action"),"location"===e?i.selectLocationById(d):"prefer"===e?i.setPreferredLocationById(d):"remove"===e&&i.removeLocationById(d)});var j=function(a){i.recentLocations.add(a)&&i.render()};a.on(this.eventNamespaceBase+":component:search_results:location",function(a){j(a)}),a.on(this.eventNamespaceBase+":component:geolocation:location",function(a){j(a)}),a.on(this.eventNamespaceBase+":component:auto_complete:location",function(a){j(a)})}}var g={element:function(){return a("<div />").addClass("ls-ui-comp-user_locations")},preferredLocationList:a("<ul/>").addClass("ls-ui-comp-user_locations-preferred"),preferredLocationHeading:function(b){return a("<p />").text(b.get("user_locations.heading.preferred"))},recentLocationsList:a("<ul/>").addClass("ls-ui-comp-user_locations-recent"),recentLocationsHeading:function(b,c){return a("<p />").text(b.get("user_locations.heading.recent")+" ("+c+")")},location:function(b,c){var d=c.id,e=a("<a/>").addClass("ls-ui-comp-user_locations-name").attr("href","#"+d).attr("data-id",d).attr("data-action","location").html(a("<strong/>").text(c.name));c.container&&e.append(", "+c.container);var f=a("<a/>").addClass("ls-ui-comp-user_locations-action").attr("href","#"+d).attr("data-id",d).attr("data-action",c.isPreferred?"none":"prefer").text(b.get("user_locations.action.recent")),g=a("<a/>").addClass("ls-ui-comp-user_locations-remove").attr("href","#"+d).attr("data-id",d).attr("data-action","remove").text(b.get("user_locations.action.remove")),h=a("<li />");return c.isPreferred&&h.addClass("ls-ui-comp-user_locations-location-preferred"),c.isPreferable&&(h.addClass("ls-ui-comp-user_locations-location-preferable"),h.append(f)),h.append(e).append(g),h},message:function(b,c){var d=b.get("user_locations.message.preferred");return c&&(d+=" "+b.get("user_locations.message.change_preferred")),a("<p/>").addClass("ls-ui-comp-user_locations-message").text(d)}};return f.prototype=new b,f.prototype.constructor=f,f.prototype.selectLocationById=function(b){var c;c=this._locations[b],c&&a.emit(this.eventNamespace+":location",[c])},f.prototype.setPreferredLocationById=function(a){var b,c,d;b=this,c=this._locations[a],c&&this.preferredLocation.isValidLocation(c)&&(this.preferredLocation.isSet()&&(d=this.preferredLocation.get(),this.recentLocations.add(d)),this.preferredLocation.set(c.id,{success:function(){b.render()},error:function(){}}))},f.prototype.removeLocationById=function(a){var b;b=this._locations[a],b&&(b.isPreferred?this.preferredLocation.unset():this.recentLocations.remove(a),this.render())},f.prototype.render=function(){var a,b,c,d,e,f,h,i;if(c=this.preferredLocation.isSet(),d=this.getRecentLocations(),h=d.length,f=h>0,a=c||f,this._locations={},this.element.empty(),g.preferredLocationList.empty(),g.recentLocationsList.empty(),a&&this.element.append(g.preferredLocationHeading(this.translations)),c?(b=this.preferredLocation.get(),this._locations[b.id]=b,b.isPreferred=!0,b.isPreferable=!0,g.preferredLocationList.append(g.location(this.translations,b))):g.preferredLocationList.addClass("ls-ui-comp-user_locations-preferred-no-location"),a&&this.element.append(g.preferredLocationList),f){for(this.element.append(g.recentLocationsHeading(this.translations,h)),i=0;h>i;i++)e=d[i],this._locations[e.id]=e,g.recentLocationsList.append(g.location(this.translations,e));this.element.append(g.recentLocationsList)}a&&this.element.append(g.message(this.translations,f))},f.prototype.getRecentLocations=function(){var a,b,c,d,e,f=[],g=5;if(this.preferredLocation.isSet()&&(g--,a=this.preferredLocation.get()),this.recentLocations.isSupported()&&(b=this.recentLocations.all(),c=b.length,c>0))for(e=0;c>e&&(d=b[e],g>0&&(!a||a.id!==d.id)&&(g--,d.isPreferable=this.preferredLocation.isValidLocation(d),f.push(d)),0!==g);e++);return f},f});