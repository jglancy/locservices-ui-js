define(["jquery","locservices/ui/component/component","locservices/core/bbc_cookies","locservices/core/recent_locations","locservices/core/preferred_location","locservices/core/filter"],function(a,b,c,d,e,f){"use strict";function g(b){var f,g,i,j=this;if(b=b||{},b.componentId="user_locations",void 0===b.api)throw new Error("User locations requires api parameter");if(f=b.api,this.setComponentOptions(b),g=new c,!g.isPersonalisationDisabled()){this._locations=[],i=f.getDefaultQueryParameters(),this._filter={filter:i.filter,country:i.countries,placeType:i["place-types"]},this.preferredLocation=new e(f),this.recentLocations=new d,this.element=h.element(),this.container.append(this.element),this.render(),this.element.on("click",function(b){var c,d,e,f;b.preventDefault(),b.stopPropagation(),c=a(b.target),d=String(c.data("id")),f=j._locations[d],f&&(e=c.data("action"),"location"===e?j.selectLocationById(d):"prefer"===e?j.displayDialog(c.parent("li"),j.translations.get("user_locations.dialog.prefer"),function(){j.setPreferredLocationById(d)}):"remove"===e&&(f.isPreferred?j.displayDialog(c.parent("li"),j.translations.get("user_locations.dialog.remove_preferred"),function(){j.removeLocationById(d)}):j.removeLocationById(d)))});var k=function(a){j.recentLocations.add(a)&&j.render()};a.on(this.eventNamespaceBase+":component:search_results:location",function(a){k(a)}),a.on(this.eventNamespaceBase+":component:geolocation:location",function(a){k(a)}),a.on(this.eventNamespaceBase+":component:auto_complete:location",function(a){k(a)})}}var h={element:function(){return a("<div />").addClass("ls-ui-comp-user_locations")},preferredLocationList:a("<ul/>").addClass("ls-ui-comp-user_locations-preferred"),preferredLocationHeading:function(b){return a("<p />").addClass("ls-ui-comp-user_locations-heading").text(b.get("user_locations.heading.preferred"))},recentLocationsList:a("<ul/>").addClass("ls-ui-comp-user_locations-recent"),recentLocationsHeading:function(b,c){return a("<p />").addClass("ls-ui-comp-user_locations-heading").addClass("ls-ui-comp-user_locations-recent-heading").text(b.get("user_locations.heading.recent")+" ("+c+")")},location:function(b,c){var d=c.id,e=a("<a/>").addClass("ls-ui-comp-user_locations-name").attr("href","#"+d).attr("data-id",d).attr("data-action","location").html(a("<strong/>").text(c.name));c.container&&e.append(", "+c.container);var f=a("<a/>").addClass("ls-ui-comp-user_locations-action").attr("href","#"+d).attr("data-id",d).attr("data-action",c.isPreferred?"none":"prefer").text(b.get("user_locations.action.recent")),g=a("<a/>").addClass("ls-ui-comp-user_locations-remove").attr("href","#"+d).attr("data-id",d).attr("data-action","remove").text(b.get("user_locations.action.remove")),h=a("<li />");return h.addClass("ls-ui-comp-user_locations-location"),c.isPreferred&&h.addClass("ls-ui-comp-user_locations-location-preferred"),c.isPreferable&&(h.addClass("ls-ui-comp-user_locations-location-preferable"),h.append(f)),h.append(e).append(g),h},message:function(b,c){var d=b.get("user_locations.message.preferred");return c&&(d+=" "+b.get("user_locations.message.change_preferred")),a("<p/>").addClass("ls-ui-comp-user_locations-message").text(d)},dialog:function(b,c){var d=a("<div/>").addClass("ls-ui-comp-user_locations-dialog"),e=a("<p/>").text(c),f=a("<div/>").addClass("ls-ui-comp-user_locations-dialog-buttons"),g=a("<span/>").append(a("<button/>"));g.addClass("ls-ui-comp-user_locations-dialog-confirm").find("button").text(b.get("user_locations.dialog.confirm"));var h=a("<span/>").append(a("<button/>"));return h.addClass("ls-ui-comp-user_locations-dialog-cancel").find("button").text(b.get("user_locations.dialog.cancel")),f.append(g).append(h),d.append(e).append(f),d}};return g.prototype=new b,g.prototype.constructor=g,g.prototype.displayDialog=function(a,b,c){var d=function(){a.find(".ls-ui-comp-user_locations-dialog").remove(),a.removeClass("ls-ui-comp-user_locations-location-with-dialog")};a.addClass("ls-ui-comp-user_locations-location-with-dialog"),a.append(h.dialog(this.translations,b)),a.find(".ls-ui-comp-user_locations-dialog-confirm button").on("click",function(){d(),"function"==typeof c&&c()}),a.find(".ls-ui-comp-user_locations-dialog-cancel button").on("click",function(){d()})},g.prototype.selectLocationById=function(a){var b;b=this._locations[a],b&&this.emit("location",[b])},g.prototype.setPreferredLocationById=function(a){var b,c,d;b=this,c=this._locations[a],c&&this.preferredLocation.isValidLocation(c)&&(this.recentLocations.remove(a),this.element.find(".ls-ui-comp-user_locations-location-preferred").removeClass("ls-ui-comp-user_locations-location-preferred"),this.element.find('a[data-id="'+a+'"]').parent().addClass("ls-ui-comp-user_locations-location-preferred"),this.preferredLocation.isSet()&&(d=this.preferredLocation.get(),this.recentLocations.add(d)),this.preferredLocation.set(c.id,{success:function(){b.render()},error:function(){b.emit("error",[{code:"user_locations.error.preferred_location",message:"There was an error setting preferred location to "+c.id}])}}))},g.prototype.removeLocationById=function(a){var b;b=this._locations[a],b&&(b.isPreferred?this.preferredLocation.unset():this.recentLocations.remove(a),this.render())},g.prototype.render=function(){var a,b,c,d,e,f,g,i;if(c=this.preferredLocation.isSet(),d=this.getRecentLocations(),g=d.length,f=g>0,a=c||f,this._locations={},this.element.empty(),h.preferredLocationList.empty(),h.recentLocationsList.empty(),a&&this.element.append(h.preferredLocationHeading(this.translations)),c?(b=this.preferredLocation.get(),this._locations[b.id]=b,b.isPreferred=!0,b.isPreferable=!0,h.preferredLocationList.append(h.location(this.translations,b))):h.preferredLocationList.addClass("ls-ui-comp-user_locations-preferred-no-location"),a&&this.element.append(h.preferredLocationList),f){for(this.element.append(h.recentLocationsHeading(this.translations,g)),i=0;g>i;i++)e=d[i],this._locations[e.id]=e,h.recentLocationsList.append(h.location(this.translations,e));this.element.append(h.recentLocationsList)}a&&this.element.append(h.message(this.translations,f))},g.prototype.getRecentLocations=function(){var a,b,c,d,e,g=[];if(this.preferredLocation.isSet()&&(a=this.preferredLocation.get()),this.recentLocations.isSupported()&&(b=f(this.recentLocations.all(),{filter:this._filter.filter,placeType:this._filter.placeType,country:this._filter.country}),c=b.length,c>0))for(c>4&&(b=b.slice(0,4),c=4),e=0;c>e;e++)d=b[e],a&&a.id===d.id||(d.isPreferable=this.preferredLocation.isValidLocation(d),g.push(d));return g},g});