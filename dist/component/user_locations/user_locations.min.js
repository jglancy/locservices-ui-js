define(["jquery","locservices/ui/component/component","locservices/ui/component/dialog","locservices/core/bbc_cookies","locservices/core/recent_locations","locservices/core/preferred_location","locservices/core/filter"],function(a,b,c,d,e,f,g){"use strict";function h(b){var c,g,h,j=this;if(b=b||{},b.componentId="user_locations",void 0===b.api)throw new Error("User locations requires api parameter");if(c=b.api,this.setComponentOptions(b),g=new d,!g.isPersonalisationDisabled()){this._locations=[],h=c.getDefaultQueryParameters(),this._filter={filter:h.filter,country:h.countries,placeType:h["place-types"]},this.preferredLocation=new f(c),this.recentLocations=new e,this.element=i.element(),this.container.append(this.element),this.render(),this.element.on("click",function(b){var c,d,e,f;b.preventDefault(),b.stopPropagation(),c=a(b.target),d=String(c.data("id")),f=j._locations[d],f&&(e=c.data("action"),"location"===e?j.selectLocationById(d):"prefer"===e?j.displayDialog(c.parent("li"),j.translations.get("user_locations.dialog.prefer",{name:f.name}),function(){j.setPreferredLocationById(d)}):"remove"===e&&(f.isPreferred?j.displayDialog(c.parent("li"),j.translations.get("user_locations.dialog.remove_preferred",{name:f.name}),function(){j.removeLocationById(d)}):j.removeLocationById(d)))});var k=function(a){j.recentLocations.add(a)&&(j.emit("location_add",[a]),j.render())};a.on(this.eventNamespaceBase+":component:search_results:location",function(a){k(a)}),a.on(this.eventNamespaceBase+":component:geolocation:location",function(a){k(a)}),a.on(this.eventNamespaceBase+":component:auto_complete:location",function(a){k(a)})}}var i={element:function(){return a("<div />").addClass("ls-ui-comp-user_locations")},preferredLocationList:a("<ul/>").addClass("ls-ui-comp-user_locations-preferred"),preferredLocationHeading:function(b){return a("<p />").addClass("ls-ui-comp-user_locations-heading").text(b.get("user_locations.heading.preferred"))},recentLocationsList:a("<ul/>").addClass("ls-ui-comp-user_locations-recent"),recentLocationsHeading:function(b,c){return a("<p />").addClass("ls-ui-comp-user_locations-heading").addClass("ls-ui-comp-user_locations-recent-heading").text(b.get("user_locations.heading.recent")+" ("+c+")")},location:function(b,c){var d=c.id,e=a("<a/>").addClass("ls-ui-comp-user_locations-name").attr("href","#"+d).attr("data-id",d).attr("data-action","location").html(a("<strong/>").text(c.name));c.container&&e.append(", "+c.container);var f=a("<a/>").addClass("ls-ui-comp-user_locations-action").attr("href","#"+d).attr("data-id",d).attr("data-action",c.isPreferred?"none":"prefer").text(b.get("user_locations.action.recent")),g=a("<a/>").addClass("ls-ui-comp-user_locations-remove").attr("href","#"+d).attr("data-id",d).attr("data-action","remove").text(b.get("user_locations.action.remove")),h=a("<li />");return h.addClass("ls-ui-comp-user_locations-location"),c.isPreferred&&h.addClass("ls-ui-comp-user_locations-location-preferred"),c.isPreferable&&(h.addClass("ls-ui-comp-user_locations-location-preferable"),h.append(f)),h.append(e).append(g),h},message:function(b,c){var d=b.get("user_locations.message.preferred");return c&&(d+=" "+b.get("user_locations.message.change_preferred")),a("<p/>").addClass("ls-ui-comp-user_locations-message").text(d)}};return h.prototype=new b,h.prototype.constructor=h,h.prototype.displayDialog=function(a,b,d){var e=function(){a.removeClass("ls-ui-comp-user_locations-location-with-dialog")};a.addClass("ls-ui-comp-user_locations-location-with-dialog"),new c({container:a,message:b,confirmLabel:this.translations.get("user_locations.dialog.confirm"),cancelLabel:this.translations.get("user_locations.dialog.cancel"),confirm:function(){e(),"function"==typeof d&&d()},cancel:function(){e()}})},h.prototype.selectLocationById=function(a){var b;b=this._locations[a],b&&this.emit("location",[b])},h.prototype.setPreferredLocationById=function(a){var b,c,d;b=this,c=this._locations[a],c&&this.preferredLocation.isValidLocation(c)&&(this.recentLocations.remove(a),this.element.find(".ls-ui-comp-user_locations-location-preferred").removeClass("ls-ui-comp-user_locations-location-preferred"),this.element.find('a[data-id="'+a+'"]').parent().addClass("ls-ui-comp-user_locations-location-preferred"),this.preferredLocation.isSet()&&(d=this.preferredLocation.get(),this.recentLocations.add(d)),this.preferredLocation.set(c.id,{success:function(){b.render(),b.emit("location_prefer",[a])},error:function(){b.emit("error",[{code:"user_locations.error.preferred_location",message:"There was an error setting preferred location to "+c.id}])}}))},h.prototype.removeLocationById=function(a){var b;b=this._locations[a],b&&(b.isPreferred?this.preferredLocation.unset():this.recentLocations.remove(a),this.render(),this.emit("location_remove",[a]))},h.prototype.render=function(){var a,b,c,d,e,f,g,h;if(c=this.preferredLocation.isSet(),d=this.getRecentLocations(),g=d.length,f=g>0,a=c||f,this._locations={},this.element.empty(),i.preferredLocationList.empty(),i.recentLocationsList.empty(),a&&this.element.append(i.preferredLocationHeading(this.translations)),c?(b=this.preferredLocation.get(),this._locations[b.id]=b,b.isPreferred=!0,b.isPreferable=!0,i.preferredLocationList.append(i.location(this.translations,b))):i.preferredLocationList.addClass("ls-ui-comp-user_locations-preferred-no-location"),a&&this.element.append(i.preferredLocationList),f){for(this.element.append(i.recentLocationsHeading(this.translations,g)),h=0;g>h;h++)e=d[h],this._locations[e.id]=e,i.recentLocationsList.append(i.location(this.translations,e));this.element.append(i.recentLocationsList)}a&&this.element.append(i.message(this.translations,f))},h.prototype.getRecentLocations=function(){var a,b,c,d,e,f=[];if(this.preferredLocation.isSet()&&(a=this.preferredLocation.get()),this.recentLocations.isSupported()&&(b=g(this.recentLocations.all(),{filter:this._filter.filter,placeType:this._filter.placeType,country:this._filter.country}),c=b.length,c>0))for(c>4&&(b=b.slice(0,4),c=4),e=0;c>e;e++)d=b[e],a&&a.id===d.id||(d.isPreferable=this.preferredLocation.isValidLocation(d),f.push(d));return f},h});